<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ROBUXVN.SHOP - RÚT ROBUX GIÁ RẺ NHẤT 2026</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500;700&family=Orbitron:wght@900&display=swap" rel="stylesheet">
<style>
  /* Giữ nguyên toàn bộ style gốc của bạn */
  #popup { backdrop-filter: blur(6px); }
  #popupBox { border: 4px solid var(--accent); background: linear-gradient(165deg, #ffffff, #f2fffa); box-shadow: 0 0 35px rgba(0, 212, 170, 0.45); }
  #popupBox p { font-size: 17px !important; line-height: 1.55 !important; }
  #popupBox h3 { font-size: 24px !important; letter-spacing: 1px; text-shadow: 0 0 12px rgba(0,212,170,0.45); }
  @keyframes popupFade { from { opacity: 0; transform: translateY(40px) scale(.85); } to { opacity: 1; transform: translateY(0) scale(1); } }
  #popupBox { animation: popupFade .45s ease; }
  :root{ --accent:#00d4aa; --gold:#f1c40f; --border:#00d4aa; }
  *{margin:0;padding:0;box-sizing:border-box}
  body{ background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); font-family:'Roboto',sans-serif; min-height:100vh; overflow-x:hidden; }
  .header{ background:linear-gradient(135deg,#00d4aa,#00a085); padding:24px 10px;text-align:center; box-shadow:0 10px 40px rgba(0,212,170,0.5); }
  .header h1{ font-family:'Orbitron',sans-serif; font-size:clamp(1.8rem, 7vw, 3.4rem); color:#fff; text-shadow:0 0 18px #000, 3px 3px 0 var(--gold); letter-spacing:2px; line-height:1.2; word-break:break-word; }
  .header p{ color:#fff; font-size:clamp(1.1rem, 4vw, 1.5rem); margin-top:8px; font-weight:900; text-shadow:0 0 12px #000; }
  #loginPage{ position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:99999; display:flex;align-items:center;justify-content:center;padding:15px; }
  .login-box{ background:#fff;padding:35px 30px;border-radius:25px; width:100%;max-width:370px;box-shadow:0 20px 60px rgba(0,212,170,0.7); border:5px solid var(--accent);text-align:center; }
  .nav{ display:flex;justify-content:center;flex-wrap:nowrap;overflow-x:auto; gap:6px;padding:10px 5px;background:#fff;position:sticky;top:0;z-index:99; box-shadow:0 5px 20px rgba(0,0,0,0.15);scrollbar-width:none; border-bottom:3px solid var(--accent); }
  .nav::-webkit-scrollbar{display:none}
  .nav button{ white-space:nowrap;background:#fff;color:#000;padding:11px 10px; border-radius:14px;font-weight:700;font-size:13px;min-width:88px; transition:.3s;display:flex;align-items:center;justify-content:center; text-align:center;line-height:1.2; }
  .nav button:hover,.nav button.active{ background:var(--accent);color:#fff; transform:translateY(-3px);box-shadow:0 10px 25px rgba(0,212,170,0.5); }
  .container{ max-width:760px;margin:18px auto;background:#fff; padding:24px;border-radius:25px; border:5px solid var(--border); box-shadow:0 18px 55px rgba(0,212,170,0.32); overflow:hidden; }
  h2{color:var(--accent);text-align:center;margin-bottom:20px; font-size:clamp(1.8rem,5vw,2.5rem);}
  input,button,select{ width:100%;padding:15px;margin:10px 0; border-radius:14px;font-size:16.5px;font-weight:600; }
  input,select{background:#f8f9fa;border:3px solid #ddd;}
  input:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 18px rgba(0,212,170,0.4);}
  button{ background:linear-gradient(45deg,var(--accent),#00b894); color:#fff;border:none;cursor:pointer; box-shadow:0 8px 25px rgba(0,212,170,0.4); }
  button:hover{transform:translateY(-5px);box-shadow:0 16px 35px rgba(0,212,170,0.6);}
  .packages{ display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:20px 0; }
  .pkg{ background:#f0f2f5;padding:16px;border-radius:14px;text-align:center; cursor:pointer;font-weight:bold;font-size:15px; border:2.5px solid #ddd;transition:.3s; }
  .pkg:hover,.pkg.selected{ background:var(--accent);color:#fff;border-color:var(--accent); transform:scale(1.06); }
  #robuxPreview{ font-size:clamp(27px,7vw,37px);color:var(--gold); text-align:center;margin:22px 0;font-weight:bold; text-shadow:0 0 18px var(--gold); }
  .tab{display:none}.tab.active{display:block}
  .hidden{display:none}
  .gd-item{padding:12px;background:#fff;margin:7px 0;border-radius:10px;border-left:5px solid var(--accent);font-size:14.5px;}
  #gdList{height:230px;overflow:hidden;border:3px solid var(--accent);border-radius:14px;background:#f9f9f9;padding:10px;}
  .hist-item{padding:15px;margin:10px 0;border-radius:12px;background:#fafafa;border-left:6px solid var(--accent);position:relative;}
  .hist-item.rut{border-left-color:#e74c3c;}
  .status{position:absolute;top:10px;right:12px;font-size:12px;font-weight:bold;padding:5px 10px;border-radius:8px;}
  .status.pending{background:#fff3cd;color:#e67e22;}
  .status.success{background:#d4edda;color:#27ae60;}
  .status.failed{background:#f8d7da;color:#c0392b;}
  @media (max-width:480px){ .container{padding:18px;margin:12px 8px;} .packages{grid-template-columns:repeat(3,1fr);gap:10px;} .pkg{font-size:14px;padding:14px 6px;} .nav button{font-size:12.5px;min-width:80px;padding:10px 6px;} }
  #popup{ position:fixed; inset:0; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:999999; }
  #popupBox{ background:#fff; padding:25px; border-radius:18px; width:90%; max-width:360px; text-align:center; animation:pop .35s ease; }
  @keyframes pop {from{transform:scale(.6); opacity:0} to{transform:scale(1); opacity:1}}
  /* Dòng chữ Lộc Phát 2 bên (Tết) */
  .tet-text {
    position: fixed;
    bottom: 20px;
    font-family: 'Roboto', sans-serif;
    font-size: 2.5rem;
    font-weight: bold;
    color: #ff0000;
    text-shadow: 0 0 15px #ffd700, 0 0 30px #ff4500;
    z-index: 9998;
    pointer-events: none;
    animation: glow 2s infinite alternate;
  }
  .tet-left { left: 20px; transform: rotate(-15deg); }
  .tet-right { right: 20px; transform: rotate(15deg); }
  @keyframes glow {
    from { text-shadow: 0 0 10px #ffd700, 0 0 20px #ff4500; }
    to { text-shadow: 0 0 20px #ffd700, 0 0 40px #ff4500; }
  }
  @media (max-width: 768px) {
    .tet-text { font-size: 1.8rem; bottom: 10px; }
  }
  /* Thêm hiển thị chiết khấu thẻ cào */
  #cardDiscount { text-align:center; font-weight:bold; color:#f1c40f; margin:10px 0; }
</style>
</head>
<body>

<!-- PHÁO HOA (tia vỡ ra đơn giản ở 2 bên chỗ trống, nổ liên tục mỗi 5s) -->
<canvas id="fireworksCanvas" style="position: fixed; top: 0; left: 0; pointer-events: none; z-index: -1;"></canvas>

<script>
// Pháo hoa tia vỡ ra đơn giản ở 2 bên, nổ liên tục
const canvas = document.getElementById('fireworksCanvas');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
const ctx = canvas.getContext('2d');

let particles = [];

class Particle {
  constructor(x, y) {
    this.x = x;
    this.y = y;
    this.color = 'rgba(255, 255, 255, 0.7)'; // tia trắng đơn giản
    this.radius = Math.random() * 1.5 + 1;
    this.velocity = {
      x: (Math.random() - 0.5) * 15,
      y: (Math.random() - 0.5) * 15
    };
    this.alpha = 1;
    this.friction = 0.98;
  }

  draw() {
    ctx.save();
    ctx.globalAlpha = this.alpha;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
    ctx.fillStyle = this.color;
    ctx.fill();
    ctx.restore();
  }

  update() {
    this.velocity.x *= this.friction;
    this.velocity.y *= this.friction;
    this.x += this.velocity.x;
    this.y += this.velocity.y;
    this.alpha -= 0.01;
  }
}

function createFirework() {
  const positions = [canvas.width * 0.1, canvas.width * 0.9]; // 2 bên chỗ trống
  positions.forEach(x => {
    const y = canvas.height / 2;
    for (let i = 0; i < 30; i++) {
      particles.push(new Particle(x, y));
    }
  });
}

function animate() {
  requestAnimationFrame(animate);
  ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  particles.forEach((particle, i) => {
    if (particle.alpha > 0) {
      particle.draw();
      particle.update();
    } else {
      particles.splice(i, 1);
    }
  });
}

animate();

setInterval(createFirework, 5000);
</script>

<!-- LOGIN (đã thêm auto-login vĩnh viễn từ localStorage) -->
<div id="loginPage">
  <div class="login-box">
    <h2>ROBUXVN.SHOP</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Mật khẩu">
    <input type="text" id="refCode" placeholder="Mã giới thiệu (nếu có)">
    <button onclick="login()">ĐĂNG NHẬP</button>
    <button onclick="register()" style="background:#f1c40f;color:#000">ĐĂNG KÝ NGAY</button>
  </div>
</div>

<!-- HEADER -->
<div class="header">
  <h1>ROBUXVN.SHOP</h1>
  <p>SHOP ROBUX RẺ NHẤT 2026</p>
</div>

<div class="nav">
  <button onclick="openTab('home')" class="active">TRANG CHỦ</button>
  <button onclick="openTab('nap')">NẠP ROBUX</button>
  <button onclick="openTab('rut')">RÚT ROBUX</button>
  <button onclick="openTab('giftcode')">GIFTCODE</button>
  <button onclick="openTab('danhgia')">ĐÁNH GIÁ</button>
  <button onclick="logout()" style="background:#e74c3c">ĐĂNG XUẤT</button>
</div>

<div class="container">
  <!-- HOME -->
  <div id="home" class="tab active">
    <h2>Xin chào <span id="name">bạn</span>!</h2>
    <p style="text-align:center;font-size:31px;margin:35px 0">
      Số dư: <b id="bal" style="color:var(--gold)">0</b> Robux
    </p>
    <div style="text-align:center">
      <button onclick="openTab('nap')" style="padding:20px 70px;font-size:23px">NẠP ROBUX NGAY</button>
    </div>

    <!-- GIAO DỊCH GẦN ĐÂY -->
    <div style="margin-top:35px">
      <h2 style="font-size:22px;margin-bottom:12px;text-align:left">Giao dịch gần đây</h2>
      <div id="gdList"></div>
    </div>
  </div>

  <!-- NẠP ROBUX -->
  <div id="nap" class="tab">
    <h2>NẠP ROBUX</h2>
    <p style="text-align:center;color:#555;margin-bottom:15px" id="rateDisplay">10.000đ = 65 Robux</p>
    <select id="napMethod" onchange="toggleNap()">
      <option value="qr">QR NGÂN HÀNG (TỰ ĐỘNG)</option>
      <option value="thecao">NẠP THẺ CÀO</option>
    </select>
    <div id="qrBox">
      <input type="number" id="qrAmount" placeholder="Nhập số tiền (VD: 100000)" oninput="calcQR()">
      <div id="qrPreview">0 Robux</div>
      <div class="packages">
        <div class="pkg" onclick="setQR(50000)">50.000đ</div>
        <div class="pkg" onclick="setQR(100000)">100.000đ</div>
        <div class="pkg" onclick="setQR(200000)">200.000đ</div>
        <div class="pkg" onclick="setQR(500000)">500.000đ</div>
      </div>
      <button onclick="createQR()">NẠP NGAY</button>
    </div>
    <div id="cardBox" class="hidden">
      <p style="text-align:center;font-weight:bold;margin:15px 0">Chọn mệnh giá:</p>
      <div class="packages">
        <div class="pkg" onclick="chooseCard(10000)">10.000đ</div>
        <div class="pkg" onclick="chooseCard(20000)">20.000đ</div>
        <div class="pkg" onclick="chooseCard(50000)">50.000đ</div>
        <div class="pkg" onclick="chooseCard(100000)">100.000đ</div>
        <div class="pkg" onclick="chooseCard(200000)">200.000đ</div>
        <div class="pkg" onclick="chooseCard(500000)">500.000đ</div>
      </div>
      <select id="cardType" onchange="updateCardDiscount()">
        <option>Viettel</option>
        <option>Vinaphone</option>
        <option>Mobifone</option>
        <option>Zing</option>
        <option>Gate</option>
      </select>
      <p id="cardDiscount" style="text-align:center; font-weight:bold; color:#f1c40f; margin:10px 0;">Chiết khấu 20% - Thực nhận 0 Robux</p>
      <input type="text" id="seri" placeholder="Số seri">
      <input type="text" id="code" placeholder="Mã thẻ">
      <button onclick="sendCard()">NẠP NGAY</button>
    </div>
    <!-- LỊCH SỬ NẠP -->
    <h2 style="margin-top:30px;font-size:21px;text-align:left">Lịch sử nạp</h2>
    <div id="lsNap"></div>
  </div>

  <!-- RÚT -->
  <div id="rut" class="tab">
    <h2>RÚT ROBUX</h2>
    <input type="text" placeholder="Username Roblox" id="rbxUser">
    <input type="number" placeholder="Số Robux muốn rút" id="rbxAmt">
    <button onclick="rutRobux()">GỬI YÊU CẦU</button>
    <!-- LỊCH SỬ RÚT -->
    <h2 style="margin-top:30px;font-size:21px;text-align:left">Lịch sử rút</h2>
    <div id="lsRut"></div>
  </div>

  <!-- GIFTCODE -->
  <div id="giftcode" class="tab">
    <h2>NHẬP GIFTCODE</h2>
    <input type="text" id="giftInput" placeholder="Nhập mã giftcode">
    <button onclick="useGift()">SỬ DỤNG</button>
  </div>

  <!-- ĐÁNH GIÁ -->
  <div id="danhgia" class="tab">
    <h2>ĐÁNH GIÁ 5★</h2>
    <div id="reviews"></div>
  </div>
</div>

<!-- POPUP ĐẸP -->
<div id="popup">
  <div id="popupBox">
    <h3 style="font-size:22px;color:#00d4aa;margin-bottom:10px">THÔNG BÁO</h3>
    <p id="popupText" style="font-size:16px; line-height:1.6; margin-bottom:20px"></p>
    <button onclick="closePopup()"
      style="background:#00d4aa;color:#fff;padding:12px 25px;border:none;border-radius:12px;font-weight:bold">
      Đóng
    </button>
  </div>
</div>

<script>
let currentUser = {username: "guest", balance: 0, password: ""};
let cardAmount = 0;
let lsNap = [];
let lsRut = [];
let robuxRate = 65;

// Auto-login vĩnh viễn từ localStorage
window.addEventListener('load', () => {
  const savedUser = localStorage.getItem('currentUser');
  if (savedUser) {
    currentUser = JSON.parse(savedUser);
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("name").innerText = currentUser.username;
    document.getElementById("bal").innerText = currentUser.balance;
    renderHistory();
  }
  fetchRate();
});

async function fetchRate() {
  const res = await fetch("/api/rate");
  const data = await res.json();
  robuxRate = data.rate;
  document.getElementById("rateDisplay").innerText = `10.000đ = ${robuxRate} Robux`;
}

function hideName(n){
  if(!n || n.length < 4) return "*****";
  const half = Math.ceil(n.length / 2);
  return n.substring(0, half) + "*".repeat(n.length - half);
}

const fakeNames = ["datmuoi","nguyenvan","trananh","phamthi","levan","hotuan","dangkim","buivan","lythithu","vuminh","khanhvy","minhthu","hoanganh","tuananh","ngochan"];
function fakeTransaction(){
  const names = fakeNames[Math.floor(Math.random()*fakeNames.length)];
  const type = Math.random() > 0.5 ? "nạp" : "rút";
  if(type==="nạp"){
    const amounts = [50000,100000,200000,300000,500000];
    const amt = amounts[Math.floor(Math.random()*amounts.length)];
    return `${hideName(names)} vừa nạp ${amt.toLocaleString()}đ`;
  } else {
    const robux = [150,300,500,800,1000,2000][Math.floor(Math.random()*6)];
    return `${hideName(names)} rút ${robux.toLocaleString()} Robux`;
  }
}

function renderRecentTransactions(){
  const real = [];
  lsNap.slice(-6).forEach(t=>real.push(`${hideName(t.user)} nạp ${t.amount?.toLocaleString() || "??"}đ (+${t.robux} Robux)`));
  lsRut.slice(-6).forEach(t=>real.push(`${hideName(t.user)} rút ${t.robux} Robux → ${hideName(t.to)}`));
  const fake = Array(10).fill().map(()=>fakeTransaction());
  const all = [...real, ...fake].sort(()=>0.5-Math.random()).slice(0,16);
  document.getElementById("gdList").innerHTML = all.map(t=>`<div class="gd-item">${t}</div>`).join('');
}
setInterval(renderRecentTransactions, 3500);
renderRecentTransactions();

async function renderHistory(){
  const res = await fetch("/api/history/" + currentUser.username);
  const data = await res.json();

  lsNap = data.deposits;
  lsRut = data.withdraws;

  const napDiv = document.getElementById("lsNap");
  if(napDiv){
    const myNap = [...lsNap].reverse();
    napDiv.innerHTML = myNap.length===0 ? "<div class='hist-item'>Chưa có lịch sử nạp</div>" : myNap.map(t=>`
      <div class="hist-item">
        +${t.robux} Robux ${t.amount?`(${t.amount.toLocaleString()}đ)`:""}<br>
        <small>${new Date(t.time).toLocaleString()}</small>
        <div class="status ${t.status}">${t.status==="pending"?"Đang xét duyệt":(t.status==="success"?"Thành công":"Thất bại")}</div>
      </div>
    `).join('');
  }

  const rutDiv = document.getElementById("lsRut");
  if(rutDiv){
    const myRut = [...lsRut].reverse();
    rutDiv.innerHTML = myRut.length===0 ? "<div class='hist-item rut'>Chưa có lịch sử rút</div>" : myRut.map(t=>`
      <div class="hist-item rut">
        -${t.robux} Robux → <b>${t.to}</b><br>
        <small>${new Date(t.time).toLocaleString()}</small>
        <div class="status ${t.status}">${t.status==="pending"?"Đang xét duyệt":(t.status==="success"?"Thành công":"Thất bại")}</div>
      </div>
    `).join('');
  }

  const loginRes = await fetch("/api/login",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({username: currentUser.username, password: currentUser.password})
  });
  const userData = await loginRes.json();
  if(!userData.error){
    currentUser.balance = userData.balance;
    document.getElementById("bal").innerText = userData.balance;
  }

  renderRecentTransactions();
}

function showPopup(text){
  document.getElementById("popupText").innerHTML = text;
  document.getElementById("popup").style.display="flex";
}
function closePopup(){document.getElementById("popup").style.display="none";}

async function login(){
  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value;

  const res = await fetch("/api/login",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ username:u, password:p })
  });

  const data = await res.json();

  if(data.error) return alert(data.error);

  currentUser = data;
  currentUser.password = p;

  localStorage.setItem('currentUser', JSON.stringify(currentUser));

  document.getElementById("loginPage").style.display="none";
  document.getElementById("name").innerText = data.username;
  document.getElementById("bal").innerText = data.balance;
  alert("Đăng nhập thành công! Chào " + u + "!");
  setTimeout(()=>{
    showPopup(`
      ⏳ <b>THỜI GIAN DUYỆT ĐƠN:</b> 1 - 3 ngày<br><br>
      Không nhận thẻ VietnamMobile<br>
      Hỗ trợ thẻ cào / chuyển khoản / auto<br><br>
      Có thắc mắc hãy liên hệ Shop<br><br>
      "Giá rẻ quá scam?"<br>
      → Hãy thử nạp 10.000đ để test nhé!
    `);
  },600);
  await renderHistory();
}

async function register(){
  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value;
  const ref = document.getElementById("refCode").value.trim();

  if (p.length < 6) return alert("Mật khẩu phải có ít nhất 6 ký tự!");

  const res = await fetch("/api/register",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ username:u, password:p, refCode: ref })
  });

  const data = await res.json();

  if(data.error) return alert(data.error);

  alert("Đăng ký thành công! Giờ đăng nhập đi bro!");
}

function logout(){
  if(confirm("Đăng xuất ngay hả bro?")) {
    localStorage.removeItem('currentUser');
    location.reload();
  }
}

function calcQR(){
  const m = parseInt(document.getElementById("qrAmount").value)||0;
  const r = Math.floor(m/10000 * robuxRate);
  document.getElementById("qrPreview").innerHTML = `<b>${r.toLocaleString()}</b> Robux`;
}

async function createQR(){
  const amount = parseInt(document.getElementById("qrAmount").value);
  if(!amount || amount < 10000) return alert("Tối thiểu 10.000đ nha bro!");
  const robux = Math.floor(amount/10000 * robuxRate);
  const noiDung = `ROBUXVN-${currentUser.username.toUpperCase()}-${amount}`;
  const qrUrl = `https://img.vietqr.io/image/mbbank-0939546882-compact.png?amount=${amount}&addInfo=${encodeURIComponent(noiDung)}&accountName=ROBUXVN%20SHOP`;
  
  showPopup(`
    <b>Quét QR để chuyển khoản</b><br><br>
    <img src="${qrUrl}" style="width:230px;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,0.4)"><br><br>
    <b>STK:</b> 0939546882 (MB Bank)<br>
    <b>Nội dung:</b> <span style="color:#00d4aa">${noiDung}</span><br><br>
    Sau khi chuyển khoản, đơn sẽ được admin duyệt thủ công!
  `);

  await fetch("/api/deposit",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
        user: currentUser.username,
        amount,
        robux,
        type: "bank"
    })
  });
  await renderHistory();
}

function setQR(x){document.getElementById("qrAmount").value=x;calcQR();}

function chooseCard(amount){
  cardAmount = amount;
  document.querySelectorAll("#cardBox .pkg").forEach(p=>p.classList.remove("selected"));
  event.target.classList.add("selected");
  updateCardDiscount();
}

function updateCardDiscount() {
  if (cardAmount === 0) {
    document.getElementById("cardDiscount").innerText = "Chọn mệnh giá để xem chiết khấu";
    return;
  }
  const cardType = document.getElementById("cardType").value.toUpperCase();
  let discount = 0;
  if (cardType === "VIETTEL" || cardType === "MOBIFONE") discount = 20;
  else if (cardType === "VINAPHONE" || cardType === "ZING" || cardType === "GATE") discount = 15;

  const realValue = Math.floor(cardAmount * (100 - discount) / 100);
  const realRobux = Math.floor(realValue / 10000 * robuxRate);

  document.getElementById("cardDiscount").innerText = `Chiết khấu ${discount}% - Thực nhận ${realRobux.toLocaleString()} Robux`;
}

async function sendCard(){
  if(cardAmount===0) return alert("Chọn mệnh giá trước đã bro!");
  const seri = document.getElementById("seri").value.trim();
  const code = document.getElementById("code").value.trim();
  const cardType = document.getElementById("cardType").value;
  if(!seri || !code) return alert("Nhập đầy đủ seri + mã thẻ!");
  alert(`Thẻ ${cardAmount.toLocaleString()}đ đã gửi!\nAdmin sẽ duyệt thủ công trong 1-3 phút!`);
  
  const robux = Math.floor(cardAmount / 10000 * robuxRate); // robux gốc gửi server
  await fetch("/api/deposit",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
        user: currentUser.username,
        amount: cardAmount,
        robux,
        type:"card",
        seri,
        code,
        cardType
    })
  });
  
  document.getElementById("seri").value = "";
  document.getElementById("code").value = "";
  cardAmount = 0;
  document.querySelectorAll("#cardBox .pkg").forEach(p=>p.classList.remove("selected"));
  document.getElementById("cardDiscount").innerText = "Chiết khấu 20% - Thực nhận 0 Robux";
  await renderHistory();
}

async function rutRobux(){
  const toUser = document.getElementById("rbxUser").value.trim();
  const amt = parseInt(document.getElementById("rbxAmt").value);
  if(!toUser || !amt || amt < 50) return alert("Nhập username Roblox + số Robux (tối thiểu 50)!");
  
  await fetch("/api/withdraw",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
        user: currentUser.username,
        robux: amt,
        to: toUser
    })
  });
  
  alert("Yêu cầu rút đã gửi! Admin sẽ duyệt thủ công và donate trong 5-60 phút");
  document.getElementById("rbxUser").value="";
  document.getElementById("rbxAmt").value="";
  await renderHistory();
}

function openTab(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelector(`button[onclick="openTab('${id}')"]`).classList.add('active');
  if(id==="nap" || id==="rut") renderHistory();
}
function toggleNap(){
  const v = document.getElementById("napMethod").value;
  document.getElementById("qrBox").classList.toggle("hidden", v==="thecao");
  document.getElementById("cardBox").classList.toggle("hidden", v!=="thecao");
  if (v === "thecao") updateCardDiscount();
}
function useGift(){
  const c = document.getElementById("giftInput").value.trim().toUpperCase();
  if(["NOEL2025","ROBUXVN","FREE500"].includes(c)){
    alert("NHẬN 500 ROBUX THÀNH CÔNG!");
  }else alert("Mã giftcode sai rồi bro!");
}
const reviews = ["Rút 1 phút có","Nạp thẻ cào tự động","Giá rẻ nhất VN","Admin donate nhanh","Shop đẹp xỉu","24/7 có người duyệt!"];
reviews.forEach(t=>{
  document.getElementById("reviews").innerHTML += `
    <div style="background:#f9f9f9;padding:20px;margin:16px 0;border-radius:18px;border-left:6px solid var(--gold);box-shadow:0 8px 25px rgba(0,0,0,0.1)">
      <div style="color:var(--gold);font-size:2rem">★★★★★</div>
      <p style="margin:8px 0;font-weight:bold">Khách hàng ẩn danh</p>
      <p style="font-size:18px">${t}</p>
    </div>`;
});
</script>
</body>
</html>
