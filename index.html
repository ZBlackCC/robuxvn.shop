<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ROBUXVN.SHOP - DEMO (SANDBOX)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500;700&family=Orbitron:wght@900&display=swap" rel="stylesheet">
<style>
  :root{
    --accent:#00d4aa;
    --gold:#f1c40f;
    --border:#00d4aa;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    font-family:'Roboto',sans-serif;
    min-height:100vh;
    overflow-x:hidden;
  }

  /* DEMO BANNER */
  .demo-banner{
    position:fixed;left:10px;top:10px;background:rgba(0,0,0,0.6);
    color:#fff;padding:8px 12px;border-radius:10px;z-index:999999;
    font-weight:700;font-size:13px;box-shadow:0 6px 18px rgba(0,0,0,0.4);
  }

  /* TUYẾT RƠI */
  .snow{
    position:fixed;top:-10px;width:8px;height:8px;
    background:#fff;border-radius:50%;pointer-events:none;
    box-shadow:0 0 12px #fff;opacity:0.8;z-index:9999;
    animation:snowfall linear infinite;
  }
  @keyframes snowfall{to{transform:translateY(100vh) rotate(360deg);}}

  /* HEADER */
  .header{
    background:linear-gradient(135deg,#00d4aa,#00a085);
    padding:18px 10px;text-align:center;
    box-shadow:0 10px 40px rgba(0,212,170,0.5);
  }
  .header h1{
    font-family:'Orbitron',sans-serif;
    font-size:clamp(1.6rem, 5vw, 2.4rem);
    color:#fff;
    text-shadow:0 0 12px #000, 2px 2px 0 var(--gold);
    letter-spacing:1px;
    line-height:1.2;
  }
  .header p{
    color:#fff;
    font-size:clamp(0.95rem, 3vw, 1.15rem);
    margin-top:6px;
    font-weight:800;
    text-shadow:0 0 8px #000;
  }

  /* LOGIN */
  #loginPage{
    position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:99999;
    display:flex;align-items:center;justify-content:center;padding:15px;
  }
  .login-box{
    background:#fff;padding:28px 22px;border-radius:18px;
    width:100%;max-width:360px;box-shadow:0 20px 60px rgba(0,212,170,0.7);
    border:4px solid var(--accent);text-align:center;
  }

  /* NAV + CONTAINER */
  .nav{
    display:flex;justify-content:center;flex-wrap:nowrap;overflow-x:auto;
    gap:6px;padding:8px 8px;background:#fff;position:sticky;top:0;z-index:99;
    box-shadow:0 5px 20px rgba(0,0,0,0.12);scrollbar-width:none;
    border-bottom:3px solid var(--accent);
    align-items:center;
  }
  .nav::-webkit-scrollbar{display:none}
  .nav button{
    white-space:nowrap;background:#fff;color:#000;padding:8px 10px;
    border-radius:14px;font-weight:700;font-size:13px;min-width:75px;
    transition:.25s;border:2px solid #eee;flex-shrink:0;
    overflow:hidden;text-overflow:ellipsis;
  }
  .nav button:hover,.nav button.active{
    background:var(--accent);color:#fff;
    transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,212,170,0.45);
  }

  .container{
    max-width:760px;margin:14px auto;background:#fff;
    padding:18px;border-radius:18px;
    border:4px solid var(--border);
    box-shadow:0 18px 55px rgba(0,212,170,0.24);
    overflow:hidden;
  }

  h2{color:var(--accent);text-align:center;margin-bottom:12px;
     font-size:clamp(1.4rem,4vw,1.8rem);}

  input,button,select{
    width:100%;padding:12px;margin:8px 0;
    border-radius:12px;font-size:15px;font-weight:600;
  }
  input,select{background:#f8f9fa;border:2px solid #eee;}
  input:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 12px rgba(0,212,170,0.3);}
  button{
    background:linear-gradient(45deg,var(--accent),#00b894);
    color:#fff;border:none;cursor:pointer;
    box-shadow:0 8px 20px rgba(0,212,170,0.3);
  }
  button:hover{transform:translateY(-4px);box-shadow:0 14px 30px rgba(0,212,170,0.5);}

  .packages{
    display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:14px 0;
  }
  .pkg{
    background:#f0f2f5;padding:12px;border-radius:12px;text-align:center;
    cursor:pointer;font-weight:800;font-size:14px;
    border:2px solid #eee;transition:.25s;
  }
  .pkg:hover,.pkg.selected{
    background:var(--accent);color:#fff;border-color:var(--accent);
    transform:scale(1.04);
  }

  #robuxPreview{
    font-size:clamp(20px,5vw,28px);color:var(--gold);
    text-align:center;margin:14px 0;font-weight:bold;
    text-shadow:0 0 12px var(--gold);
  }

  .tab{display:none}.tab.active{display:block}
  .hidden{display:none}

  .gd-item{
    padding:10px;background:#fff;margin:6px 0;border-radius:10px;border-left:5px solid var(--accent);
    display:flex;justify-content:space-between;align-items:center;
  }
  .gd-item small{color:#666;font-size:12px}

  /* POPUP ĐẸP */
  #popup{
    position:fixed; inset:0;
    background:rgba(0,0,0,0.7);
    display:none; justify-content:center; align-items:center;
    z-index:999999;
  }
  #popupBox{
    background:#fff; padding:20px; border-radius:12px;
    width:92%; max-width:420px; text-align:center;
    animation:pop .28s ease;
  }
  @keyframes pop {from{transform:scale(.9); opacity:0} to{transform:scale(1); opacity:1}}

  /* small helper for history boxes */
  .hist-box{
    padding:12px;margin:8px 0;border-radius:10px;background:#fafafa;border-left:6px solid var(--accent);
    display:flex;justify-content:space-between;align-items:center;
  }
  .hist-box.rut{border-left-color:#e74c3c;}
  .status-badge{padding:6px 10px;border-radius:10px;font-weight:800;font-size:13px}
  .status-pending{background:#fff3cd;color:#856404;border:1px solid #ffe8a1}
  .status-done{background:#e6ffef;color:#0b6626;border:1px solid #c6f3d1}

  /* admin floating toggle */
  .admin-toggle{
    position:fixed;right:12px;bottom:12px;background:var(--accent);
    color:#fff;padding:10px 12px;border-radius:12px;z-index:999999;font-weight:800;
    box-shadow:0 12px 30px rgba(0,0,0,0.2);cursor:pointer;
  }

  @media (max-width:480px){
    .container{padding:14px;margin:10px 8px;}
    .packages{grid-template-columns:repeat(3,1fr);gap:8px;}
    .pkg{font-size:13px;padding:10px 6px;}
    .nav button{min-width:68px;padding:7px 8px;font-size:12px}
  }
</style>
</head>
<body>

<div class="demo-banner">DEMO SANDBOX — KHÔNG THỰC HIỆN GIAO DỊCH THẬT</div>

<!-- LOGIN -->
<div id="loginPage">
  <div class="login-box">
    <h2>ROBUXVN.SHOP (DEMO)</h2>
    <input type="text" id="username" placeholder="Username (>=6 ký tự)">
    <input type="password" id="password" placeholder="Mật khẩu (>=6 ký tự)">
    <button onclick="login()">ĐĂNG NHẬP</button>
    <button onclick="register()" style="background:#f1c40f;color:#000">ĐĂNG KÝ NGAY (DEMO)</button>
    <p style="margin-top:8px;font-size:13px;color:#666">Đăng nhập là local demo. Để truy cập chế độ admin dùng username: <b>admin</b> (mật khẩu bất kỳ)</p>
  </div>
</div>

<!-- HEADER -->
<div class="header">
  <h1>ROBUXVN.SHOP</h1>
  <p>SHOP ROBUX - DEMO 2025</p>
</div>

<div class="nav">
  <button onclick="openTab('home')" class="active">TRANG CHỦ</button>
  <button onclick="openTab('nap')">NẠP ROBUX</button>
  <button onclick="openTab('rut')">RÚT ROBUX</button>
  <button onclick="openTab('vongquay')">VÒNG QUAY</button>
  <button onclick="openTab('giftcode')">GIFTCODE</button>
  <button onclick="openTab('danhgia')">ĐÁNH GIÁ</button>
  <button onclick="logout()" style="background:#e74c3c">ĐĂNG XUẤT</button>
</div>

<div class="container">
  <!-- HOME -->
  <div id="home" class="tab active">
    <h2>Xin chào <span id="name">bạn</span>!</h2>
    <p style="text-align:center;font-size:24px;margin:20px 0">
      Số dư: <b id="bal" style="color:var(--gold)">0</b> Robux
    </p>
    <div style="text-align:center">
      <button onclick="openTab('nap')" style="padding:12px 40px;font-size:16px">NẠP ROBUX NGAY</button>
    </div>

    <!-- GIAO DỊCH GẦN ĐÂY (auto scroll + mix thật/ảo) -->
    <div style="margin-top:20px">
      <h2 style="font-size:18px;margin-bottom:10px;text-align:left">Giao dịch gần đây</h2>
      <div id="gdList" style="height:200px; overflow:hidden; border:2px solid var(--accent); border-radius:10px; background:#f9f9f9; padding:8px"></div>
    </div>
  </div>

  <!-- NẠP ROBUX -->
  <div id="nap" class="tab">
    <h2>NẠP ROBUX</h2>
    <p style="text-align:center;color:#555;margin-bottom:10px">10.000đ = 65 Robux (DEMO)</p>

    <select id="napMethod" onchange="toggleNap()">
      <option value="qr">QR NGÂN HÀNG (DEMO)</option>
      <option value="thecao">NẠP THẺ CÀO (DEMO)</option>
    </select>

    <div id="qrBox">
      <input type="number" id="qrAmount" placeholder="Nhập số tiền (VD: 100000)" oninput="calcQR()">
      <div id="qrPreview">0 Robux</div>
      <div class="packages">
        <div class="pkg" onclick="setQR(50000)">50K</div>
        <div class="pkg" onclick="setQR(100000)">100K</div>
        <div class="pkg" onclick="setQR(200000)">200K</div>
        <div class="pkg" onclick="setQR(500000)">500K</div>
      </div>
      <button onclick="createQR()">NẠP NGAY (DEMO)</button>
    </div>

    <div id="cardBox" class="hidden">
      <p style="text-align:center;font-weight:bold;margin:10px 0">Chọn mệnh giá:</p>
      <div class="packages">
        <div class="pkg" onclick="chooseCard(10000)">10K</div>
        <div class="pkg" onclick="chooseCard(20000)">20K</div>
        <div class="pkg" onclick="chooseCard(50000)">50K</div>
        <div class="pkg" onclick="chooseCard(100000)">100K</div>
        <div class="pkg" onclick="chooseCard(200000)">200K</div>
        <div class="pkg" onclick="chooseCard(500000)">500K</div>
      </div>
      <select id="cardType">
        <option>Viettel</option><option>Vinaphone</option><option>Mobifone</option><option>Zing</option><option>Gate</option>
      </select>
      <input type="text" id="seri" placeholder="Số seri">
      <input type="text" id="code" placeholder="Mã thẻ">
      <button onclick="sendCard()">NẠP NGAY (DEMO)</button>
    </div>

    <!-- LỊCH SỬ NẠP ROBUX -->
    <h2 style="margin-top:12px;font-size:16px;text-align:left">Lịch sử nạp</h2>
    <div id="lsNapBox"></div>
  </div>

  <!-- RÚT -->
  <div id="rut" class="tab">
    <h2>RÚT ROBUX</h2>
    <input type="text" placeholder="Username Roblox" id="rbxUser">
    <input type="number" placeholder="Số Robux muốn rút" id="rbxAmt">
    <button id="rutBtn">GỬI YÊU CẦU (DEMO)</button>

    <!-- LỊCH SỬ RÚT ROBUX -->
    <h2 style="margin-top:12px;font-size:16px;text-align:left">Lịch sử rút</h2>
    <div id="lsRutBox"></div>
  </div>

  <!-- VÒNG QUAY -->
  <div id="vongquay" class="tab">
    <h2>VÒNG QUAY MAY MẮN (DEMO)</h2>
    <p style="text-align:center;font-size:16px;margin-bottom:12px">
      Giá quay: <b style="color:var(--gold)">30 Robux</b>/lần
    </p>
    <div style="text-align:center">
      <canvas id="wheel" width="330" height="330"></canvas>
      <div class="prize" id="prizeText">Nhấn QUAY để thử vận may!</div>
      <button onclick="spin()" style="margin-top:12px;padding:12px 36px;font-size:16px">QUAY NGAY</button>
    </div>
  </div>

  <div id="giftcode" class="tab">
    <h2>NHẬP GIFTCODE (DEMO)</h2>
    <input type="text" id="giftInput" placeholder="Nhập mã giftcode">
    <button onclick="useGift()">SỬ DỤNG</button>
  </div>

  <div id="danhgia" class="tab">
    <h2>ĐÁNH GIÁ 5★ (DEMO)</h2>
    <div id="reviews"></div>
  </div>
</div>

<!-- POPUP -->
<div id="popup">
  <div id="popupBox">
    <h3 style="font-size:20px;color:#00d4aa;margin-bottom:8px">THÔNG BÁO</h3>
    <p id="popupText" style="font-size:15px; line-height:1.6; margin-bottom:14px"></p>
    <button onclick="closePopup()"
      style="background:#00d4aa;color:#fff;padding:10px 18px;border:none;border-radius:10px;font-weight:bold">
      Đóng
    </button>
  </div>
</div>

<!-- ADMIN TOGGLE -->
<div id="adminToggle" class="admin-toggle" onclick="toggleAdmin()" title="Bật/Tắt chế độ admin (chỉ local)">
  Chế độ Admin: <span id="adminState">OFF</span>
</div>

<script>
/* ---------- DEMO / SAFETY ---------- */
const DEMO_NOTICE = "Đây là phiên bản DEMO trên trình duyệt (local). Không thực hiện giao dịch thật.";

/* ---------- BIẾN CHUNG ---------- */
let currentUser = { username: "guest", balance: 0 };
let cardAmount = 0;
let adminMode = false;

/* ---------- localStorage data ---------- */
let lsNap = JSON.parse(localStorage.getItem("lsNap") || "[]");
let lsRut = JSON.parse(localStorage.getItem("lsRut") || "[]");

/* ---------- HELPER: anonymize name (ví dụ dat*** ) ---------- */
function anonymize(name){
  if(!name) return "khách***";
  const s = name.trim();
  // lấy 3 ký tự đầu (nếu có), nếu có dấu cách thì lấy phần trước
  const short = s.split(' ')[0].slice(0,3);
  return short + "***";
}

/* ---------- POPUP ---------- */
function showPopup(text){
  document.getElementById("popupText").innerHTML = text;
  document.getElementById("popup").style.display="flex";
}
function closePopup(){document.getElementById("popup").style.display="none";}

/* ---------- LOGIN ---------- */
function login(){
  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value;
  if(u.length < 6) return alert("Username phải ít nhất 6 ký tự!");
  if(p.length < 6) return alert("Mật khẩu phải ít nhất 6 ký tự!");

  currentUser = {username:u, balance: Number(localStorage.getItem("bal_"+u) || 0)};
  document.getElementById("loginPage").style.display="none";
  document.getElementById("name").innerText = u;
  document.getElementById("bal").innerText = currentUser.balance;
  alert("Đăng nhập (DEMO) thành công! Chào " + u + "!");

  // hiển thị DEMO popup ngắn
  setTimeout(()=> showPopup(`<b>DEMO:</b> ${DEMO_NOTICE}`), 250);

  updateNapLS();
  updateRutLS();
  renderFeed();
}

/* ---------- REGISTER ---------- */
function register(){
  const u = document.getElementById("username").value.trim();
  if(u.length < 6) return alert("Username phải ít nhất 6 ký tự!");
  // tạo user demo (local)
  localStorage.setItem("bal_"+u, "0");
  alert("Đăng ký (DEMO) thành công! Đăng nhập để tiếp tục.");
}

/* ---------- LOGOUT ---------- */
function logout(){
  if(confirm("Đăng xuất (DEMO)?")) location.reload();
}

/* ---------- ADMIN MODE ---------- */
function toggleAdmin(){
  adminMode = !adminMode;
  document.getElementById("adminState").innerText = adminMode ? "ON" : "OFF";
  // chỉ cho phép "admin" thực tế có quyền approve demo nếu login là admin
  // Nếu muốn cho mọi user thử, comment dòng dưới:
  // if(adminMode && currentUser.username !== 'admin'){ alert('Chỉ user "admin" mới có quyền approve trong demo.'); adminMode=false; document.getElementById("adminState").innerText = "OFF"; return; }
  renderFeed(); updateNapLS(); updateRutLS();
}

/* ---------- QR AUTO (DEMO) ---------- */
function calcQR(){
  const m = parseInt(document.getElementById("qrAmount").value)||0;
  const r = Math.floor(m/10000*65);
  document.getElementById("qrPreview").innerHTML = `<b>${r.toLocaleString()}</b> Robux`;
}
function setQR(x){document.getElementById("qrAmount").value=x;calcQR();}

function createQR(){
  const amount = parseInt(document.getElementById("qrAmount").value);
  if(!amount || amount < 10000) return alert("Tối thiểu 10.000đ (DEMO)!");
  const user = currentUser.username || "guest";
  // LƯU: default là Đang xét (admin sẽ duyệt)
  const rb = Math.floor(amount/10000*65);
  const obj = { user, amount, robux: rb, time: new Date().toLocaleString(), status: "Đang xét", note: "QR (DEMO)" };
  lsNap.push(obj); persistNap();
  addTransactionDisplay(`${anonymize(user)} nạp ${amount.toLocaleString()}đ (${rb} Robux)`);
  updateNapLS();
  showPopup("Yêu cầu nạp đã được ghi (DEMO). Trạng thái: Đang xét. Admin bấm 'Đã duyệt' để cộng Robux.");
}

/* ---------- NẠP THẺ (DEMO) ---------- */
function chooseCard(amount){
  cardAmount = amount;
  document.querySelectorAll("#cardBox .pkg").forEach(p=>p.classList.remove('selected'));
  if(event && event.target) event.target.classList.add("selected");
}
function sendCard(){
  if(cardAmount===0) return alert("Chọn mệnh giá trước đã bro!");
  const seri = document.getElementById("seri").value.trim();
  const code = document.getElementById("code").value.trim();
  if(!seri || !code) return alert("Nhập đầy đủ seri + mã thẻ (DEMO)!");
  const rb = Math.floor(cardAmount/10000*65);
  const obj = { user: currentUser.username || "guest", amount: cardAmount, robux: rb, time: new Date().toLocaleString(), status: "Đang xét", note: "Thẻ (DEMO)" };
  lsNap.push(obj); persistNap();
  addTransactionDisplay(`${anonymize(currentUser.username)} gửi thẻ ${cardAmount.toLocaleString()}đ (chờ duyệt)`);
  document.getElementById("seri").value = "";
  document.getElementById("code").value = "";
  cardAmount = 0;
  document.querySelectorAll("#cardBox .pkg").forEach(p=>p.classList.remove("selected"));
  updateNapLS();
}

/* ---------- GIFTCODE ---------- */
function useGift(){
  const c = document.getElementById("giftInput").value.trim().toUpperCase();
  if(["NOEL2025","ROBUXVN","FREE500"].includes(c)){
    const rb = 500;
    const obj = { user: currentUser.username || "guest", amount: 0, robux: rb, time: new Date().toLocaleString(), status: "Đã duyệt (AUTO)", note: `Giftcode ${c}` };
    lsNap.push(obj); persistNap();
    addTransactionDisplay(`${anonymize(currentUser.username)} sử dụng giftcode ${c} nhận 500 Robux`);
    // cộng ngay vì trạng thái đã duyệt (demo)
    creditBalanceIfMatch(currentUser.username, rb);
    updateNapLS();
  } else alert("Mã giftcode sai rồi bro! (DEMO)");
}

/* ---------- VÒNG QUAY (giữ nguyên) ---------- */
const prizes = ["5","10","30","50","200","500 Robux"];
const colors = ["#95a5a6","#7289da","#2ecc71","#3498db","#e74c3c","#f1c40f"];
function drawWheel(){
  const ctx = document.getElementById("wheel").getContext("2d");
  prizes.forEach((p,i)=>{
    ctx.fillStyle = colors[i];
    ctx.beginPath();
    ctx.moveTo(165,165);
    ctx.arc(165,165,165,i*60*Math.PI/180,(i+1)*60*Math.PI/180);
    ctx.fill();
    ctx.save();ctx.translate(165,165);ctx.rotate((i+0.5)*60*Math.PI/180);
    ctx.fillStyle="#fff";ctx.font="bold 16px Roboto";ctx.fillText(p,70,8);ctx.restore();
  });
}
drawWheel();
let spinning = false;
function spin(){
  if(spinning) return; spinning=true;
  document.getElementById("wheel").style.transform = `rotate(${1800 + Math.random()*720}deg)`;
  setTimeout(()=>{
    const win = prizes[Math.floor(Math.random()*prizes.length)];
    document.getElementById("prizeText").innerHTML = `CHÚC MỪNG!<br><b style="font-size:2rem">${win}</b>`;
    alert("Trúng " + win + " (DEMO)!");
    const winNum = parseInt(win);
    if(!isNaN(winNum)){
      const obj = { user: currentUser.username || "guest", amount: 0, robux: winNum, time: new Date().toLocaleString(), status: "Đã duyệt (AUTO)", note: "Vòng quay (DEMO)" };
      lsNap.push(obj); persistNap();
      addTransactionDisplay(`${anonymize(currentUser.username)} trúng vòng quay ${winNum} Robux`);
      creditBalanceIfMatch(currentUser.username, winNum);
      updateNapLS();
    }
    spinning=false;
  },4000);
}

/* ---------- TRANSACTION FEED + LỊCH SỬ (localStorage) ---------- */
const feedBox = document.getElementById("gdList");
const fakeFeed = [
  "Nguyễn Hữu T. vừa nạp 100.000đ",
  "Lê Minh K. rút 340 Robux",
  "Trần Anh N. nạp 50.000đ",
  "Phạm Tấn L. nhận 120 Robux",
  "Ngô Phương D. nạp 200.000đ",
  "Khách ẩn danh rút 500 Robux",
  "Hoàng Mạnh H. nạp 300.000đ",
];

function renderFeed(){
  const recentReal = [];
  for(let i = lsNap.length-1;i>=0 && recentReal.length<6;i--){
    const e = lsNap[i];
    recentReal.push({text:`${anonymize(e.user)} nạp ${e.amount ? e.amount.toLocaleString() + "đ" : ""} ${e.robux ? "(" + e.robux + " Robux)" : ""}`, time:e.time});
  }
  for(let i = lsRut.length-1;i>=0 && recentReal.length<12;i--){
    const e = lsRut[i];
    recentReal.push({text:`${anonymize(e.user)} rút ${e.robux} Robux`, time:e.time});
  }
  const pool = [...fakeFeed.map(t=>({text:t})), ...recentReal];
  const mixed = [];
  for(let i=0;i<Math.min(12,pool.length);i++){
    mixed.push(pool[Math.floor(Math.random()*pool.length)]);
  }

  feedBox.innerHTML = mixed.map(t=>`<div class="gd-item"><div>${t.text}</div>${t.time?`<small>${t.time}</small>`:''}</div>`).join('');
}
renderFeed();

// auto-scroll
let feedScroll = 0;
setInterval(()=>{
  const box = document.getElementById("gdList");
  if(!box) return;
  renderFeed();
  feedScroll += 1;
  box.scrollTo({top: feedScroll, behavior: 'smooth'});
  if(feedScroll > box.scrollHeight - box.clientHeight) feedScroll = 0;
}, 1800);

function addTransactionDisplay(text){
  const box = document.getElementById("gdList");
  const el = document.createElement("div");
  el.className = "gd-item";
  el.innerText = text;
  box.prepend(el);
  setTimeout(()=>{ renderFeed(); }, 700);
}

/* ---------- LƯU / LOAD ---------- */
function persistNap(){ localStorage.setItem("lsNap", JSON.stringify(lsNap)); }
function persistRut(){ localStorage.setItem("lsRut", JSON.stringify(lsRut)); }

/* ---------- HIỂN THỊ LỊCH SỬ NẠP ---------- */
function updateNapLS(){
  const box = document.getElementById("lsNapBox");
  if(!box) return;
  const list = lsNap.filter(x => x.user === (currentUser.username || "guest")).reverse();
  if(list.length===0){
    box.innerHTML = `<div class="hist-box">Bạn chưa có lịch sử nạp nào.</div>`;
    return;
  }
  box.innerHTML = list.map((x, idx)=>`
    <div class="hist-box">
      <div>
        <b>+${x.robux}</b> Robux ${x.amount ? `(${x.amount.toLocaleString()}đ)` : ''}<br>
        <small>${x.time}${x.note ? ' • ' + x.note : ''}</small>
      </div>
      <div style="text-align:right">
        <div class="status-badge ${statusClass(x.status)}">${x.status}</div>
        ${adminMode ? `<div style="margin-top:8px"><button onclick="approveNap(${lsNap.length - 1 - idx})">Đã duyệt</button></div>` : ''}
      </div>
    </div>
  `).join('');
}

/* ---------- HIỂN THỊ LỊCH SỬ RÚT ---------- */
function updateRutLS(){
  const box = document.getElementById("lsRutBox");
  if(!box) return;
  const list = lsRut.filter(x => x.user === (currentUser.username || "guest")).reverse();
  if(list.length===0){
    box.innerHTML = `<div class="hist-box rut">Bạn chưa có lịch sử rút nào.</div>`;
    return;
  }
  box.innerHTML = list.map((x, idx)=>`
    <div class="hist-box rut">
      <div>
        <b>-${x.robux}</b> Robux → ${x.to ? `<b>${x.to}</b>` : ''}<br>
        <small>${x.time}${x.note ? ' • ' + x.note : ''}</small>
      </div>
      <div style="text-align:right">
        <div class="status-badge ${statusClass(x.status)}">${x.status}</div>
        ${adminMode ? `<div style="margin-top:8px"><button onclick="approveRut(${lsRut.length - 1 - idx})">Đã duyệt</button></div>` : ''}
      </div>
    </div>
  `).join('');
}

/* ---------- STATUS helpers ---------- */
function statusClass(s){
  if(!s) return 'status-pending';
  if(s.includes('Đã duyệt')) return 'status-done';
  return 'status-pending';
}

/* ---------- APPROVE HANDLERS (admin action, local only) ---------- */
function approveNap(index){
  // index is original lsNap index (from mapping earlier)
  if(index < 0 || index >= lsNap.length) return;
  lsNap[index].status = "Đã duyệt";
  persistNap();
  // nếu người được duyệt là currentUser thì cộng luôn
  creditBalanceIfMatch(lsNap[index].user, lsNap[index].robux);
  updateNapLS();
  renderFeed();
  showPopup(`Đã duyệt nạp cho ${anonymize(lsNap[index].user)} (+${lsNap[index].robux} Robux) (DEMO).`);
}

function approveRut(index){
  if(index < 0 || index >= lsRut.length) return;
  lsRut[index].status = "Đã duyệt";
  persistRut();
  // rút thực tế: trừ balance nếu khớp currentUser và đủ dư
  if(lsRut[index].user === currentUser.username){
    if(currentUser.balance >= lsRut[index].robux){
      currentUser.balance -= lsRut[index].robux;
      localStorage.setItem("bal_"+currentUser.username, currentUser.balance);
      document.getElementById("bal").innerText = currentUser.balance;
      showPopup(`Yêu cầu rút đã duyệt. (DEMO)`);
    } else {
      showPopup("Không đủ dư (DEMO).");
    }
  }
  updateRutLS();
  renderFeed();
}

/* ---------- CREDIT BALANCE IF MATCH (helper) ---------- */
function creditBalanceIfMatch(username, rb){
  // nếu user đang đăng nhập và khớp -> cộng số dư local
  if(!username) return;
  const key = "bal_"+username;
  const old = Number(localStorage.getItem(key) || 0);
  localStorage.setItem(key, String(old + rb));
  if(currentUser.username === username){
    currentUser.balance = old + rb;
    document.getElementById("bal").innerText = currentUser.balance;
  }
}

/* ---------- RÚT (GHI LỊCH + DEMO ALERT) ---------- */
document.getElementById("rutBtn").addEventListener("click", function(){
  const userRbx = document.getElementById("rbxUser").value.trim();
  const amt = parseInt(document.getElementById("rbxAmt").value);
  if(!userRbx || !amt || amt < 1) return alert("Nhập đúng username Roblox + số Robux (DEMO)!");
  // ghi lịch sử rút, trạng thái Đang xét
  const obj = { user: currentUser.username || "guest", robux: amt, to: userRbx, time: new Date().toLocaleString(), status: "Đang xét", note: "Rút (DEMO)"};
  lsRut.push(obj); persistRut();
  addTransactionDisplay(`${anonymize(currentUser.username)} rút ${amt} Robux → ${userRbx}`);
  updateRutLS();
  alert("Yêu cầu đã gửi (DEMO). Admin duyệt để hoàn tất.");
});

/* ---------- INIT REVIEWS ---------- */
const reviews = ["Rút 1 phút có","Nạp thẻ cào tự động","Giá rẻ nhất VN","Admin donate nhanh","Shop đẹp xỉu","24/7 có người duyệt!"];
reviews.forEach(t=>{
  const container = document.getElementById("reviews");
  if(container) container.innerHTML += `
    <div style="background:#f9f9f9;padding:12px;margin:12px 0;border-radius:12px;border-left:6px solid var(--gold);box-shadow:0 8px 18px rgba(0,0,0,0.06)">
      <div style="color:var(--gold);font-size:1.25rem">★★★★★</div>
      <p style="margin:6px 0;font-weight:700">Khách hàng ẩn danh</p>
      <p style="font-size:14px">${t}</p>
    </div>`;
});

/* ---------- UTIL: openTab ---------- */
function openTab(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  const btn = Array.from(document.querySelectorAll('.nav button')).find(b => b.getAttribute('onclick') && b.getAttribute('onclick').includes(`openTab('${id}')`));
  if(btn) btn.classList.add('active');
}

/* ---------- UTIL: toggle nap method ---------- */
function toggleNap(){
  const v = document.getElementById("napMethod").value;
  document.getElementById("qrBox").classList.toggle("hidden", v==="thecao");
  document.getElementById("cardBox").classList.toggle("hidden", v!=="thecao");
}

/* ---------- ONLOAD ---------- */
document.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("name").innerText = currentUser.username || "bạn";
  document.getElementById("bal").innerText = currentUser.balance || 0;
  renderFeed();
  updateNapLS();
  updateRutLS();
});
</script>

</body>
</html>