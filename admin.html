<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ADMIN PANEL</title>
<style>
body { background:#111; color:#fff; font-family:Arial; padding:20px; margin:0; }
.box { background:#222; padding:15px; border-radius:10px; margin:10px 0; box-shadow:0 2px 5px rgba(0,255,0,0.1); }
button { padding:10px 20px; margin:5px; border:none; cursor:pointer; border-radius:5px; }
.approve { background:#27ae60; color:#fff; }
.reject { background:#e74c3c; color:#fff; }
#adminLogin { display: block; text-align:center; }
#mainPanel { display: none; }
h2 { color:#00d4aa; margin-top:30px; }
.hamburger { display:none; cursor:pointer; position:fixed; top:10px; right:20px; z-index:1000; }
.bar { background:#fff; height:3px; width:25px; margin:5px 0; transition:0.4s; }
@media (max-width: 768px) {
  .hamburger { display:block; }
  .nav { display:none; flex-direction:column; position:fixed; top:50px; right:20px; background:#222; padding:15px; box-shadow:0 5px 15px rgba(0,0,0,0.5); z-index:999; }
  .nav.active { display:flex; }
}
</style>
</head>
<body>

<div class="hamburger" onclick="toggleNav()">
  <div class="bar"></div>
  <div class="bar"></div>
  <div class="bar"></div>
</div>

<div id="adminLogin">
  <h1>Đăng nhập Admin</h1>
  <input type="text" id="adminUser" placeholder="Username"><br><br>
  <input type="password" id="adminPass" placeholder="Mật khẩu"><br><br>
  <button onclick="adminLogin()">ĐĂNG NHẬP</button>
</div>

<div id="mainPanel">
  <h1>ADMIN PANEL</h1>

  <h2>Chỉnh tỷ giá Robux (10.000đ = X Robux)</h2>
  <div>
    <input type="number" id="newRate" placeholder="Nhập tỷ giá mới" style="padding:10px; margin:5px;">
    <button onclick="setRate()" style="background:#3498db; color:#fff;">CẬP NHẬT</button>
  </div>

  <h2>Đơn nạp thẻ cào chờ duyệt</h2>
  <div id="napCard"></div>

  <h2>Đơn nạp QR ngân hàng chờ duyệt</h2>
  <div id="napQR"></div>

  <h2>Đơn rút chờ duyệt</h2>
  <div id="rut"></div>

  <h2>Lịch sử duyệt đơn</h2>
  <div id="history" style="max-height:400px; overflow-y:auto; background:#222; padding:10px; border-radius:10px;"></div>
</div>

<script>
let adminToken = localStorage.getItem("adminToken") || "";

if (adminToken) {
  document.getElementById("adminLogin").style.display = "none";
  document.getElementById("mainPanel").style.display = "block";
  load();
}

function toggleNav() {
  document.querySelector('.nav')?.classList.toggle('active');
}

async function adminLogin() {
  const u = document.getElementById("adminUser").value.trim();
  const p = document.getElementById("adminPass").value.trim();

  try {
    const res = await fetch("/api/admin/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username: u, password: p })
    });

    const data = await res.json();

    if (data.token) {
      adminToken = data.token;
      localStorage.setItem("adminToken", adminToken);
      document.getElementById("adminLogin").style.display = "none";
      document.getElementById("mainPanel").style.display = "block";
      load();
    } else {
      alert(data.error || "Sai tài khoản/mật khẩu!");
    }
  } catch (err) {
    alert("Lỗi kết nối server: " + err.message);
  }
}

async function load(){
  try {
    const res = await fetch("/api/admin/orders", {
      headers: { "Authorization": adminToken }
    });

    if (!res.ok) throw new Error("Lỗi tải dữ liệu: " + res.status);

    const data = await res.json();
    if (data.error) return alert(data.error);

    const cardDeposits = data.deposits.filter(o => o.type === "card");
    const bankDeposits = data.deposits.filter(o => o.type === "bank");

    document.getElementById("napCard").innerHTML = cardDeposits.map(o=>`
      <div class="box">
        <b>${o.user}</b> nạp thẻ ${o.amount.toLocaleString()}đ (+${o.robux} Robux thực nhận)<br>
        Seri: <b>${o.seri || 'N/A'}</b> | Code: <b>${o.code || 'N/A'}</b> | Loại: <b>${o.cardType || 'N/A'}</b><br>
        <button class="approve" onclick="appDep(${o.id})">DUYỆT</button>
        <button class="reject" onclick="rej(${o.id},'deposit')">XOÁ</button>
      </div>
    `).join("") || "<div class='box'>Không có đơn thẻ cào chờ duyệt</div>";

    document.getElementById("napQR").innerHTML = bankDeposits.map(o=>`
      <div class="box">
        <b>${o.user}</b> nạp QR ${o.amount.toLocaleString()}đ (+${o.robux} Robux)<br>
        <button class="approve" onclick="appDep(${o.id})">DUYỆT</button>
        <button class="reject" onclick="rej(${o.id},'deposit')">XOÁ</button>
      </div>
    `).join("") || "<div class='box'>Không có đơn QR chờ duyệt</div>";

    document.getElementById("rut").innerHTML = data.withdraws.map(o=>`
      <div class="box">
        <b>${o.user}</b> rút ${o.robux.toLocaleString()} Robux → ${o.to}<br>
        <button class="approve" onclick="appRut(${o.id})">DUYỆT</button>
        <button class="reject" onclick="rej(${o.id},'withdraw')">XOÁ</button>
      </div>
    `).join("") || "<div class='box'>Không có đơn rút chờ duyệt</div>";

    // Lịch sử duyệt đơn (dễ nhìn)
    const allOrders = [...data.deposits, ...data.withdraws];
    const historyHTML = allOrders.length === 0 ? "<div class='box'>Chưa có lịch sử</div>" : allOrders.map(o => `
      <div class="box" style="background:#333;">
        <b>${o.user}</b> ${o.type === "card" ? "nạp thẻ cào" : o.type === "bank" ? "nạp QR" : "rút"} 
        ${o.amount ? o.amount.toLocaleString() + 'đ' : o.robux.toLocaleString() + ' Robux'} 
        - ${o.status.toUpperCase()}<br>
        <small>${new Date(o.time).toLocaleString()}</small>
      </div>
    `).join("");

    document.getElementById("history").innerHTML = historyHTML;

  } catch (err) {
    console.error("Lỗi load:", err);
    alert("Lỗi tải dữ liệu: " + err.message);
  }
}

async function appDep(id){
  try {
    const res = await fetch("/api/admin/approve/deposit", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": adminToken },
      body: JSON.stringify({ id })
    });

    const result = await res.json();
    if (result.success) {
      alert("Duyệt nạp thành công!");
      load();
    } else {
      alert("Duyệt thất bại: " + (result.error || "Lỗi không rõ"));
    }
  } catch (err) {
    alert("Lỗi duyệt nạp: " + err.message);
  }
}

async function appRut(id){
  try {
    const res = await fetch("/api/admin/approve/withdraw", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": adminToken },
      body: JSON.stringify({ id })
    });

    const result = await res.json();
    if (result.success) {
      alert("Duyệt rút thành công!");
      load();
    } else {
      alert("Duyệt thất bại: " + (result.error || "Lỗi không rõ"));
    }
  } catch (err) {
    alert("Lỗi duyệt rút: " + err.message);
  }
}

async function rej(id, type){
  try {
    const res = await fetch("/api/admin/reject", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": adminToken },
      body: JSON.stringify({ id, type })
    });

    const result = await res.json();
    if (result.success) {
      alert("Xóa đơn thành công!");
      load();
    } else {
      alert("Xóa thất bại!");
    }
  } catch (err) {
    alert("Lỗi xóa đơn: " + err.message);
  }
}

async function setRate(){
  const rate = document.getElementById("newRate").value;
  if(!rate) return alert("Nhập tỷ giá!");
  try {
    const res = await fetch("/api/admin/set_rate", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": adminToken },
      body: JSON.stringify({ rate })
    });

    const result = await res.json();
    if (result.success) {
      alert("Tỷ giá cập nhật thành công!");
      document.getElementById("newRate").value = "";
    } else {
      alert("Cập nhật thất bại!");
    }
  } catch (err) {
    alert("Lỗi cập nhật tỷ giá: " + err.message);
  }
}

setInterval(load, 5000);
</script>
</body>
</html>
