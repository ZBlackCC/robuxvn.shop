<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ADMIN PANEL</title>
<style>
body { background:#111; color:#fff; font-family:Arial; padding:20px; }
.box { background:#222; padding:15px; border-radius:10px; margin:10px 0; }
button { padding:10px 20px; margin:5px; border:none; cursor:pointer; }
.approve { background:#27ae60; color:#fff; }
.reject { background:#e74c3c; color:#fff; }
#adminLogin { display: block; }
#mainPanel { display: none; }
</style>
</head>
<body>

<div id="adminLogin">
  <h1>Đăng nhập Admin</h1>
  <input type="text" id="adminUser" placeholder="Username">
  <input type="password" id="adminPass" placeholder="Mật khẩu">
  <button onclick="adminLogin()">ĐĂNG NHẬP</button>
</div>

<div id="mainPanel">
  <h1>ADMIN PANEL</h1>

  <h2>Chỉnh tỷ giá Robux (10.000đ = X Robux)</h2>
  <div>
    <input type="number" id="newRate" placeholder="Nhập tỷ giá mới" style="padding:10px; margin:5px;">
    <button onclick="setRate()" style="background:#3498db; color:#fff;">CẬP NHẬT</button>
  </div>

  <h2>Đơn nạp chờ duyệt</h2>
  <div id="nap"></div>

  <h2>Đơn rút chờ duyệt</h2>
  <div id="rut"></div>
</div>

<script>
let adminToken = localStorage.getItem("adminToken") || "";

if (adminToken) {
  document.getElementById("adminLogin").style.display = "none";
  document.getElementById("mainPanel").style.display = "block";
  load();
}

async function adminLogin() {
  const u = document.getElementById("adminUser").value;
  const p = document.getElementById("adminPass").value;
  const res = await fetch("/api/admin/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: u, password: p })
  });
  const data = await res.json();
  if (data.token) {
    adminToken = data.token;
    localStorage.setItem("adminToken", adminToken);
    document.getElementById("adminLogin").style.display = "none";
    document.getElementById("mainPanel").style.display = "block";
    load();
  } else {
    alert(data.error);
  }
}

async function load(){
    const res = await fetch("/api/admin/orders", {
      headers: { "Authorization": adminToken }
    });
    const data = await res.json();
    if (data.error) return alert(data.error);

    document.getElementById("nap").innerHTML =
        data.deposits.map(o=>`
            <div class="box">
                <b>${o.user}</b> nạp <b>${o.amount}</b>đ (+${o.robux} Robux) <br>
                <button class="approve" onclick="appDep(${o.id})">DUYỆT</button>
                <button class="reject" onclick="rej(${o.id},'deposit')">XOÁ</button>
            </div>
        `).join("");

    document.getElementById("rut").innerHTML =
        data.withdraws.map(o=>`
            <div class="box">
                <b>${o.user}</b> rút <b>${o.robux}</b> Robux → ${o.to} <br>
                <button class="approve" onclick="appRut(${o.id})">DUYỆT</button>
                <button class="reject" onclick="rej(${o.id},'withdraw')">XOÁ</button>
            </div>
        `).join("");
}

async function appDep(id){
    await fetch("/api/admin/approve/deposit",{
        method:"POST",
        headers:{ "Content-Type":"application/json", "Authorization": adminToken },
        body: JSON.stringify({id})
    });
    load();
}

async function appRut(id){
    await fetch("/api/admin/approve/withdraw",{
        method:"POST",
        headers:{ "Content-Type":"application/json", "Authorization": adminToken },
        body: JSON.stringify({id})
    });
    load();
}

async function rej(id,type){
    await fetch("/api/admin/reject",{
        method:"POST",
        headers:{ "Content-Type":"application/json", "Authorization": adminToken },
        body: JSON.stringify({id,type})
    });
    load();
}

async function setRate(){
    const rate = document.getElementById("newRate").value;
    if(!rate) return alert("Nhập tỷ giá!");
    await fetch("/api/admin/set_rate",{
        method:"POST",
        headers:{ "Content-Type":"application/json", "Authorization": adminToken },
        body: JSON.stringify({rate})
    });
    alert("Tỷ giá cập nhật thành công!");
    document.getElementById("newRate").value = "";
}

setInterval(load,3000);
</script>
</body>
</html>
